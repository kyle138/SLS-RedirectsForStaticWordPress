service: sls-wpnh-simple-redirects
# app and org for use with dashboard.serverless.com
#app: your-app-name
#org: your-org-name

# You can pin your service to only deploy with a specific Serverless version
# Check out our docs for more details
frameworkVersion: '1'

custom:
  stage: ${opt:stage, "dev1"} # dev1, v1, dev2, v2, etc
  config: ${file(resources/${self:custom.stage}-config.yml)}

provider:
  name: aws
  runtime: nodejs12.x
  memorySize: 128
  timeout: 30
  region: us-east-1
  stage: ${self:custom.stage}
  # Environment variables
  environment:
    DEFAULTDOMAIN: ${self:custom.config.defaultDomain}
    DOMAINSETTINGSS3BUCKET: ${self:custom.config.domainSettingsS3Bucket}
    DOMAINSETTINGS3KEY: ${self:custom.config.domainSettingsS3Key}
  # IAM statements
  # Give lambda role access to domain settings file in S3
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "s3:ListBucket"
      Resource: { "Fn::Join" : ["", ["arn:aws:s3:::", ${self:custom.config.domainSettingsS3Bucket} ] ]  }
    - Effect: "Allow"
      Action:
        - "s3:GetObject"
      Resource:
        Fn::Join:
          - ""
          - - "arn:aws:s3:::"
            - ${self:custom.config.domainSettingsS3Bucket}
            - ${self:custom.config.domainSettingsS3Key}

# you can add packaging information here
#package:
#  include:
#    - include-me.js
#    - include-me-dir/**
#  exclude:
#    - exclude-me.js
#    - exclude-me-dir/**

functions:
  simpleRedirectAtEdge:
    handler: lambdas/simpleRedirect.handler
    events:
      - cloudFront:
          eventType: origin-response
          pathPattern: /
          behavior:
            ViewerProtocolPolicy: allow-all
            ForwardedValues:
              QueryString: true
          origin:
            DomainName: nighthawk.kylemunz.com.s3-website-us-east-1.amazonaws.com
            CustomOriginConfig:
              OriginProtocolPolicy: "http-only"

# CloudFormation resource templates
resources:
  Resources:
    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Comment: CF for S3 WPNH
          PriceClass: PriceClass_100
          Aliases:
            - nighthawk2.kylemunz.com
          ViewerCertificate:
            AcmCertificateArn: arn:aws:acm:us-east-1:304786516436:certificate/4bdc677c-00ac-4da4-bb6d-2c6b9d8cfe65
            SslSupportMethod: sni-only
          DefaultCacheBehavior:
            ViewerProtocolPolicy: redirect-to-https
